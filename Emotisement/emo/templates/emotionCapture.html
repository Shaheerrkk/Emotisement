<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/emotionCapture.css">
    
    <title>Emotisement - View Videos</title>
    <style>
        .bg-img{
        background: url('/static/bg2.jpg') fixed;
        height: 100vh;
        background-size: cover;
        background-position: center;
    }
        
    </style>
</head>
<body class='bg-img'>
<nav>
    {% if user.is_authenticated %}
    <a href="{% url 'signout' %}" >Logout</a>
    
    
    {% endif %}
</nav>
    <h2 style="margin-left:-38px;">Videos</h2>
    {% if videos %}
        <ul>
            
            {% for video in videos %}
            <br>
            <div style="display: flex;align-items: center;">
                
            <div style="border: 2px solid white;margin: 0 auto; display: inline-block; padding: 10px; color:white;background:black;width:700px;height:250px">
               <h3 >Title: {{ video.title }}</h3>
                <div style="display: flex; flex-direction: row; ">


                    <div >

                        <video style="border-radius: 15px" onclick="openInNewTab('{{ MEDIA_URL }}{{ video.video_file }}', '{{ video.id }}')" >
                            <source src="{{ MEDIA_URL }}{{video.video_file}}" type="video/mp4"/>
                        </video>
                    </div>

                    <div style="margin-left: 15px ;">

                      
                        <p>
                            <h5>

                                Description:
                                {{ video.description }}
                            </h5>
                        </p>
                        <p>

                            <h5>
                                Tags:
                                
                            {{ video.tags }}
                            </h5>
                        </p>
                    </div>

                </div>
            </div>
                
            </div>
            {% endfor %}
            
        </ul>
    {% else %}
        <p>No videos uploaded yet.</p>
    {% endif %}

    <div id="recordingIndicator" style="display: none;">
        <p>Recording...</p>
    </div>

    <script>
     
        let duration=0
        let isRecording = false; 
        
        function openInNewTab(videoUrl,id) {
            console.log("SHIT")
            
    document.getElementById('recordingIndicator').style.display = 'none';
    newWindow=window.open(videoUrl, '_blank');



    function getVideoDuration(videoUrl) {
    const video = document.createElement('video');

    video.src = videoUrl;

    video.addEventListener('loadedmetadata', function() {
        duration= video.duration*1000
        if(!isFinite(duration)){
            duration=5000
        }
        console.log(duration)
    });
console.log("SS")

    video.load();
}

getVideoDuration(videoUrl);

let mediaStream; 
function stopMediaStream() {
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    } else {
        console.warn('Media stream is not available.');
    }
}



    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            const mediaRecorder = new MediaRecorder(stream);
            const chunks = [];
            
        mediaStream = stream;

            mediaRecorder.ondataavailable = event => {
                chunks.push(event.data);
            };


            function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


            const csrftoken = getCookie('csrftoken');

            
            mediaRecorder.onstop = () => {
                
            stopMediaStream();
                const blob = new Blob(chunks, { type: 'video/webm' });

                const videoBlobUrl = URL.createObjectURL(blob);

                const videoElement = document.createElement('video');
                videoElement.src = videoBlobUrl;
                let width=0;
                let height=0;

                videoElement.addEventListener('loadedmetadata', () => {
                    width = videoElement.videoWidth;
                    height = videoElement.videoHeight;
                        


                let formData = new FormData();
                chunks.forEach((chunk, index) => {
                    formData.append('video_chunk_' + index, chunk);
                });

                formData.append('width', width);
                formData.append('height', height);
                formData.append('id',id);

             fetch('/predict/', {
                 method: 'POST',
                 body: formData,
                 headers: {
                     'X-CSRFToken': getCookie('csrftoken')
                 }
             })
             .then(response => {
                 if (response.ok) {
                        return response.blob();
                     }
                     throw new Error('Network response was not ok.');
                 })
                 .then(processedVideoBlob => {
                    
                    const processedVideoUrl = URL.createObjectURL(processedVideoBlob);
             })
             .catch(error => {
                 console.error('Error:', error);
                 });

                    URL.revokeObjectURL(videoBlobUrl);
                });

                console.log(blob)


                document.getElementById('recordingIndicator').style.display = 'none';
            };

            mediaRecorder.start();
            document.getElementById('recordingIndicator').style.display = 'block';
            isRecording = true;

            setTimeout(() => {
                mediaRecorder.stop();
                isRecording = false;
                
            },duration); 
        })
        .catch(error => {
            console.error('Error accessing camera:', error);
        });
}

    </script>
</body>
</html>